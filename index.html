<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quran Player</title>
    
    <meta name="description" content="Listen to the Noble Quran verse by verse. Features Arabic text, translations, and audio recitation.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">

    <link rel="canonical" href="https://muslim1446.github.io/">

    <link href="data:image/svg+xml,<svg xmlns=%22http://www.w.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“–</text></svg>" rel="icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BR6YH9S6MS"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-BR6YH9S6MS');
    </script>

    <style>
        /* --- Base Styles --- */
        :root { --vh: 100vh; --accent: #00AFFF; --bg: #000000; --text: #eee; }
        html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overscroll-behavior: none;
            overflow: hidden;
        }

        /* --- Smart Loading Screen (Required for Autoplay) --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000;
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        
        .loader-content { text-align: center; }
        
        .loader-spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s infinite linear;
            margin: 0 auto 20px auto;
        }
        
        .start-btn {
            display: none; /* Hidden until loaded */
            background: var(--accent);
            color: white; border: none;
            padding: 15px 40px; font-size: 1.2rem;
            border-radius: 30px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 175, 255, 0.4);
            animation: pulse-btn 2s infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-btn { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- Layout --- */
        .container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding: 20px; padding-bottom: 120px;
        }

        #chapter-title {
            position: fixed; top: 20px; left: 20px;
            font-size: clamp(1rem, 2vw, 1.5rem); color: #888; margin: 0;
            z-index: 10;
        }

        #content-display {
            position: relative; width: 100%; max-width: 900px;
            flex-grow: 1; display: flex; flex-direction: column; justify-content: center;
        }

        #verse-text, #verse-text-next { 
            filter: invert(1); width: 100%; object-fit: contain;
            max-height: 50vh; margin-bottom: 20px;
            transition: opacity 0.3s;
        }
        
        #verse-text-next { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; pointer-events: none; }

        #translation-text {
            color: #ccc; font-weight: 300; text-align: center;
            max-height: 30vh; overflow-y: auto; line-height: 1.6;
            padding: 0 10px; font-size: 1.2rem;
        }

        /* --- Controls --- */
        #control-panel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(20,20,20,0.95);
            padding: 15px;
            display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
            border-top: 1px solid #333;
            z-index: 50;
        }
        
        select {
            background: #333; color: white; border: 1px solid #444;
            padding: 10px; border-radius: 6px; font-size: 14px;
            flex: 1 1 auto; max-width: 200px;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-content" id="loader-content">
            <div class="loader-spinner"></div>
            <div id="loader-text">Loading Quran Data...</div>
            <button id="start-btn" class="start-btn">Tap to Start</button>
        </div>
    </div>

    <div class="container">
        <h1 id="chapter-title"></h1>
        
        <div id="content-display">
            <img id="verse-text" alt="">
            <img id="verse-text-next" alt="">
            <div id="translation-text"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>
    <audio id="translation-audio-player"></audio>

    <div id="control-panel">
        <select id="chapterSelect" aria-label="Chapter"></select>
        <select id="verseSelect" aria-label="Verse"></select>
        <select id="translationSelect" aria-label="Translation"></select>
        <select id="reciterSelect" aria-label="Reciter"></select>
        <select id="translationAudioSelect" aria-label="Audio Translation"></select>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const TRANSLATIONS_CONFIG = {
            'en': { name: 'English (Saheeh Intl)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/en.sahih.xml' },
            'es': { name: 'Spanish (Isa GarcÃ­a)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/es.garcia.xml' },
            'zh': { name: 'Chinese (Ma Jian)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/zh.jian.xml' },
            'id': { name: 'Indonesian (Kemenag)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/id.indonesian.xml' },
            'fr': { name: 'French (Hamidullah)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/fr.hamidullah.xml' },
            'ru': { name: 'Russian (Kuliev)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/ru.kuliev.xml' },
            'sq': { name: 'Albanian (Sherif Ahmeti)', url: 'https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/sq.ahmeti.xml' },
            // Add other languages here as needed
        };

        const RECITERS_CONFIG = {
            'alafasy': { name: 'Mishary Alafasy', path: 'Alafasy_128kbps' },
            'sudais': { name: 'As Sudais', path: 'Abdurrahmaan_As-Sudais_192kbps' },
            'ghamadi': { name: 'Al Ghamdi', path: 'Ghamadi_40kbps' },
            'juhaynee': { name: 'Al Juhany', path: 'Abdullaah_3awwaad_Al-Juhaynee_128kbps' },
            'abbad': { name: 'Fares Abbad', path: 'Fares_Abbad_64kbps' },
            'muaiqly': { name: 'Al Muaiqly', path: 'MaherAlMuaiqly128kbps' },
            'basit': { name: 'Abdul Basit', path: 'Abdul_Basit_Murattal_192kbps' }
        };

        const TRANSLATION_AUDIO_CONFIG = {
            'none': { name: 'No Audio Translation' },
            'en_walk': { name: 'English (Ibrahim Walk)', path: 'English/Sahih_Intnl_Ibrahim_Walk_192kbps' },
            'id_ministry': { name: 'Indonesian (Ministry)', path: 'httpIA://dn721906.ca.archive.org/0/items/AlQuran-terjemahan-indonesia-tanpa-bahasa-arab' },
            'es_custom': { name: 'EspaÃ±ol', path: 'custom_es_url' }
        };

        // --- 2. STATE VARIABLES ---
        let quranData = [];
        let allTranslations = {};
        let forbiddenSet = new Set();
        let inactivityTimer;
        
        const els = {
            overlay: document.getElementById('loading-overlay'),
            spinner: document.querySelector('.loader-spinner'),
            loaderText: document.getElementById('loader-text'),
            startBtn: document.getElementById('start-btn'),
            
            audio: document.getElementById('audio-player'),
            transAudio: document.getElementById('translation-audio-player'),
            
            sel: {
                ch: document.getElementById('chapterSelect'),
                v: document.getElementById('verseSelect'),
                trans: document.getElementById('translationSelect'),
                rec: document.getElementById('reciterSelect'),
                tAud: document.getElementById('translationAudioSelect')
            },
            
            disp: {
                title: document.getElementById('chapter-title'),
                img: document.getElementById('verse-text'),
                nextImg: document.getElementById('verse-text-next'),
                txt: document.getElementById('translation-text')
            }
        };

        // --- 3. INIT & FETCH ---
        async function init() {
            try {
                // Fetch JSON and Forbidden List (FTT)
                const [jsonRes, fttRes] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/2TM3TM.json'),
                    fetch('https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/a/FTT.XML')
                ]);

                const jsonData = await jsonRes.json();
                quranData = jsonData.chapters;

                const fttText = await fttRes.text();
                new DOMParser().parseFromString(fttText, "text/xml")
                    .querySelectorAll('Verse').forEach(v => 
                        forbiddenSet.add(`${v.getAttribute('chapter')}-${v.getAttribute('number')}`)
                    );

                // Fetch Translations
                await Promise.all(Object.keys(TRANSLATIONS_CONFIG).map(async key => {
                    try {
                        const res = await fetch(TRANSLATIONS_CONFIG[key].url);
                        if(res.ok) allTranslations[key] = new DOMParser().parseFromString(await res.text(), "text/xml");
                    } catch(e){}
                }));

                // Populate Selects
                populateUI();
                
                // RESTORE STATE (Deep Link & Region Detection)
                smartRestore();

                // Ready
                els.spinner.style.display = 'none';
                els.loaderText.style.display = 'none';
                els.startBtn.style.display = 'block';
                
                // Pre-load content (but don't play)
                loadVerse(false);

            } catch (e) {
                console.error(e);
                els.loaderText.textContent = "Error loading content. Please check connection.";
            }
        }

        // --- 4. SMART LOGIC ---
        function populateUI() {
            els.sel.ch.innerHTML = quranData.map((c, i) => `<option value="${i}">${c.chapterNumber}. ${c.title}</option>`).join('');
            els.sel.rec.innerHTML = Object.entries(RECITERS_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
            els.sel.tAud.innerHTML = Object.entries(TRANSLATION_AUDIO_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
            els.sel.trans.innerHTML = Object.entries(TRANSLATIONS_CONFIG).map(([k,v]) => `<option value="${k}">${v.name}</option>`).join('');
        }

        function smartRestore() {
            const saved = JSON.parse(localStorage.getItem('quranState')) || {};
            const urlParams = new URLSearchParams(window.location.search);
            const browserLang = navigator.language.split('-')[0];

            // 1. Chapter (URL > Saved > Default)
            let ch = 0;
            if (urlParams.has('chapter')) ch = parseInt(urlParams.get('chapter')) - 1;
            else if (saved.chapter !== undefined) ch = saved.chapter;
            els.sel.ch.value = ch >= 0 ? ch : 0;
            populateVerses(); // Needed before setting verse

            // 2. Verse
            let v = 0;
            if (urlParams.has('verse')) v = parseInt(urlParams.get('verse')) - 1;
            else if (saved.verse !== undefined) v = saved.verse;
            els.sel.v.value = v >= 0 ? v : 0;

            // 3. Reciter
            if (urlParams.has('reciter') && RECITERS_CONFIG[urlParams.get('reciter')]) els.sel.rec.value = urlParams.get('reciter');
            else if (saved.reciter) els.sel.rec.value = saved.reciter;

            // 4. Translation (URL > Saved > Browser Region > English)
            let tKey = 'en';
            if (urlParams.has('trans') && TRANSLATIONS_CONFIG[urlParams.get('trans')]) tKey = urlParams.get('trans');
            else if (saved.trans && TRANSLATIONS_CONFIG[saved.trans]) tKey = saved.trans;
            else if (TRANSLATIONS_CONFIG[browserLang]) tKey = browserLang;
            els.sel.trans.value = tKey;

            // 5. Audio Translation (URL > Saved > None)
            if (urlParams.has('audio_trans') && TRANSLATION_AUDIO_CONFIG[urlParams.get('audio_trans')]) els.sel.tAud.value = urlParams.get('audio_trans');
            else if (saved.audio_trans) els.sel.tAud.value = saved.audio_trans;
            
            // Set Start Button Text
            const chTitle = quranData[els.sel.ch.value].title;
            els.startBtn.textContent = `Start Surah ${chTitle}`;
        }

        function populateVerses() {
            const chIdx = els.sel.ch.value;
            els.sel.v.innerHTML = quranData[chIdx].verses.map((v, i) => `<option value="${i}">Ayat ${v.verseNumber}</option>`).join('');
        }

        // --- 5. CORE PLAYER & SEO ENGINE ---
        function loadVerse(shouldPlay) {
            const chIdx = els.sel.ch.value;
            const vIdx = els.sel.v.value;
            const chData = quranData[chIdx];
            const vData = chData.verses[vIdx];
            const chNum = chData.chapterNumber;
            const vNum = vData.verseNumber;

            // Image Crossfade
            const newSrc = `https://raw.githubusercontent.com/muslim1446/muslim1446.github.io/refs/heads/master/img/${chNum}_${vNum}.png`;
            els.disp.nextImg.src = newSrc;
            els.disp.nextImg.onload = () => {
                els.disp.img.style.opacity = 0;
                els.disp.nextImg.style.opacity = 1;
                setTimeout(() => {
                    els.disp.img.src = newSrc;
                    els.disp.img.style.opacity = 1;
                    els.disp.nextImg.style.opacity = 0;
                }, 300);
            };
            if(!els.disp.img.src) els.disp.img.src = newSrc;

            // Text Translation
            const tKey = els.sel.trans.value;
            const isForbidden = forbiddenSet.has(`${chNum}-${vNum}`);
            let transText = "Translation unavailable";
            
            if(isForbidden) {
                els.disp.txt.textContent = "";
            } else if (allTranslations[tKey]) {
                const s = allTranslations[tKey].querySelector(`sura[index="${chNum}"]`);
                const a = s ? s.querySelector(`aya[index="${vNum}"]`) : null;
                transText = a ? a.getAttribute('text') : transText;
                els.disp.txt.textContent = transText;
            }

            // Audio Source
            const rPath = RECITERS_CONFIG[els.sel.rec.value].path;
            const padCh = String(chNum).padStart(3, '0');
            const padV = String(vNum).padStart(3, '0');
            els.audio.src = `https://everyayah.com/data/${rPath}/${padCh}${padV}.mp3`;

            // Trans Audio Source
            if(!isForbidden && els.sel.tAud.value !== 'none') {
                const conf = TRANSLATION_AUDIO_CONFIG[els.sel.tAud.value];
                let base = conf.path;
                if(base.startsWith('httpIA')) base = base.replace('httpIA', 'https');
                else if (base === 'custom_es_url') base = `https://github.com/muslim1446/muslim1446.github.io/raw/refs/heads/master/play`;
                else base = `https://everyayah.com/data/${base}`;
                
                // Handle custom vs standard paths
                if(base.includes('github')) els.transAudio.src = `${base}/${padCh}${padV}.mp3`;
                else els.transAudio.src = `${base}/${padCh}${padV}.mp3`;
            } else {
                els.transAudio.src = "";
            }

            // --- DEEP SEO UPDATES ---
            saveState(chNum, vNum, chData.title, TRANSLATIONS_CONFIG[tKey].name);

            // Playback
            if(shouldPlay) {
                els.audio.play().catch(() => console.log("Waiting for interaction..."));
            }
        }

        function saveState(chNum, vNum, chName, transName) {
            const state = {
                chapter: parseInt(els.sel.ch.value),
                verse: parseInt(els.sel.v.value),
                reciter: els.sel.rec.value,
                trans: els.sel.trans.value,
                audio_trans: els.sel.tAud.value
            };
            localStorage.setItem('quranState', JSON.stringify(state));

            // 1. Update URL (Physical Page Appearance)
            const newUrl = `?chapter=${chNum}&verse=${vNum}&reciter=${state.reciter}&trans=${state.trans}&audio_trans=${state.audio_trans}`;
            window.history.pushState({path: newUrl}, '', newUrl);

            // 2. Update Title (Google Search Link Text)
            document.title = `${chName} (${vNum}) - ${transName}`;
            els.disp.title.textContent = `${chName} (${chNum}:${vNum})`;

            // 3. Update Meta Description (Google Snippet)
            document.querySelector('meta[name="description"]').setAttribute("content", 
                `Read Surah ${chName} Verse ${vNum} in ${transName}. Recitation: ${RECITERS_CONFIG[state.reciter].name}.`
            );
            
            // 4. Update Schema (Google Breadcrumbs/Childs)
            updateSchema(chNum, vNum, chName);
        }

        function updateSchema(chNum, vNum, chName) {
            const old = document.getElementById('dyn-schema');
            if(old) old.remove();

            const schema = {
                "@context": "https://schema.org",
                "@type": "BreadcrumbList",
                "itemListElement": [
                    { "@type": "ListItem", "position": 1, "name": "Quran", "item": "https://muslim1446.github.io/" },
                    { "@type": "ListItem", "position": 2, "name": `Surah ${chName}`, "item": `https://muslim1446.github.io/?chapter=${chNum}` },
                    { "@type": "ListItem", "position": 3, "name": `Ayah ${vNum}`, "item": window.location.href }
                ]
            };

            const s = document.createElement('script');
            s.id = 'dyn-schema'; s.type = 'application/ld+json';
            s.text = JSON.stringify(schema);
            document.head.appendChild(s);
        }

        function nextVerse() {
            if(els.sel.v.selectedIndex < els.sel.v.options.length - 1) {
                els.sel.v.selectedIndex++;
                loadVerse(true);
            } else if (els.sel.ch.selectedIndex < els.sel.ch.options.length - 1) {
                els.sel.ch.selectedIndex++;
                populateVerses();
                els.sel.v.selectedIndex = 0;
                loadVerse(true);
            }
        }

        // --- 6. LISTENERS ---
        els.startBtn.addEventListener('click', () => {
            els.overlay.style.opacity = 0;
            setTimeout(() => els.overlay.style.display = 'none', 500);
            loadVerse(true); // User interaction unlocks audio
        });

        els.sel.ch.addEventListener('change', () => { populateVerses(); loadVerse(true); });
        els.sel.v.addEventListener('change', () => loadVerse(true));
        els.sel.rec.addEventListener('change', () => loadVerse(els.audio.paused === false));
        els.sel.trans.addEventListener('change', () => loadVerse(false));
        els.sel.tAud.addEventListener('change', () => loadVerse(false)); // Just update source

        els.audio.addEventListener('ended', () => {
            if(els.transAudio.src && els.transAudio.src !== window.location.href) {
                els.transAudio.play().catch(() => nextVerse());
            } else { nextVerse(); }
        });
        els.transAudio.addEventListener('ended', nextVerse);

        // UI Idle
        ['mousemove','click','touchstart'].forEach(e => window.addEventListener(e, () => {
            document.body.classList.remove('idle');
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => document.body.classList.add('idle'), 4000);
        }));

        // Start
        init();

    </script>
</body>
</html>
