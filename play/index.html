<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Audio Tagger (v7 - Layout Restored)</title>
    <style>
        /* --- FIX --- Removed the entire 'html' block from v6 */

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: grid;
            grid-template-areas:
                "header"
                "player"
                "clips"
                "io";
            grid-template-rows: auto auto 1fr auto; /* Clips section will flex */
            gap: 15px;
            padding: 15px;
            background-color: #f4f4f4;
            color: #333;

            /* --- FIX ---
               Set body to 100vh and hide its own overflow.
               This contains the grid perfectly.
            */
            height: 100vh;
            width: 100vw;
            margin: 0;
            box-sizing: border-box; /* Include padding in the 100vh/vw */
            overflow: hidden; 
            /* --- END FIX --- */
        }

        header { grid-area: header; }
        #player-controls { grid-area: player; }
        #clips-section { grid-area: clips; display: flex; flex-direction: column; min-height: 150px; }
        #io-section { grid-area: io; }

        h1, h2 {
            margin: 0 0 10px 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
        }

        #player-controls {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #chapter-select {
            font-size: 1.2em;
            padding: 5px;
            margin-right: 10px;
        }

        #tag-status {
            padding: 10px 15px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 5px;
            color: #fff;
            display: inline-block;
            width: 300px;
            text-align: center;
        }

        #time-display {
            font-family: "Courier New", Courier, monospace;
            font-size: 1.5em;
            font-weight: bold;
            color: #004a99;
            margin-left: 20px;
        }

        #waveform {
            width: 100%;
            height: 128px;
            margin-top: 10px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        
        #loading-indicator {
            font-size: 1.1em;
            font-weight: bold;
            color: #d9534f;
            display: none;
            margin-left: 20px;
        }
        
        #zoom-controls {
            margin-top: 15px;
            padding: 10px;
            background-color: #fafafa;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        #zoom-controls label {
            font-weight: bold;
            margin-right: 10px;
        }
        #zoom-slider {
            width: 300px;
            vertical-align: middle;
        }

        #clips-section {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto; /* Allow THIS section to scroll */
        }

        #clips-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }
        #clips-list li {
            font-family: "Courier New", Courier, monospace;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        #clips-list li:nth-child(odd) { background-color: #f9f9f9; }
        #clips-list li button { margin-left: 15px; cursor: pointer; }

        #io-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        #io-section > div {
            display: flex;
            flex-direction: column;
        }
        #io-section textarea {
            width: 100%;
            height: 150px;
            font-family: "Courier New", Courier, monospace;
            box-sizing: border-box;
        }
        #import-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 5px;
        }
        #import-button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <header>
        <h1>üéß Online Audio Tagger (v7 - Layout Restored)</h1>
    </header>

    <section id="player-controls">
        <label for="chapter-select">Chapter:</label>
        <select id="chapter-select"></select>

        <span id="tag-status"></span>
        <span id="time-display">00:00:00.000</span>
        <span id="loading-indicator">Decoding Waveform...</span>
        
        <div id="zoom-controls">
            <label for="zoom-slider">Zoom:</label>
            <input type="range" id="zoom-slider" min="10" max="500" value="50">
            (Shortcuts: [+] / [-])
        </div>

        <div id="waveform"></div>
        
        <div>
            <strong>Shortcuts:</strong> 
            [Space]: Play/Pause |
            [‚Üê/‚Üí]: Rewind/Fwd 1s |
            [1]: Mark Arabic End |
            [2]: Mark Spanish End |
            [+/=]: Zoom In |
            [-]: Zoom Out
        </div>
    </section>

    <section id="clips-section">
        <h2>Marked Clips for <span id="current-chapter-title">...</span></h2>
        <ul id="clips-list">
            </ul>
    </section>

    <section id="io-section">
        <div>
            <h2>Import JSON</h2>
            <textarea id="import-json" placeholder="Paste your timestamps.json content here..."></textarea>
            <button id="import-button">Import and Overwrite</button>
        </div>
        <div>
            <h2>Live JSON Export</h2>
            <textarea id="export-json" readonly placeholder="Your timestamp JSON will appear here..."></textarea>
        </div>
    </section>

    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

    <script>
        // --- GLOBALS ---
        const chapterSelect = document.getElementById('chapter-select');
        const tagStatus = document.getElementById('tag-status');
        const timeDisplay = document.getElementById('time-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const clipsList = document.getElementById('clips-list');
        const currentChapterTitle = document.getElementById('current-chapter-title');
        const importJsonText = document.getElementById('import-json');
        const exportJsonText = document.getElementById('export-json');
        const importButton = document.getElementById('import-button');
        const zoomSlider = document.getElementById('zoom-slider');
        
        let wavesurfer = null;
        let db = {};
        let playerState = { currentFile: null, currentTime: 0 };
        let taggingState = 'orange';
        let currentStartTime = null;

        // --- CORE FUNCTIONS ---

        function formatTime(seconds) {
            const ms = Math.floor((seconds % 1) * 1000);
            const totalSec = Math.floor(seconds);
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(3, '0')}.${ms.toString().padStart(3, '0')}`;
        }

        function saveDB() {
            try {
                const jsonString = JSON.stringify(db, null, 2);
                localStorage.setItem('timestampDB', jsonString);
                exportJsonText.value = jsonString;
            } catch (e) {
                console.error("Failed to save DB:", e);
                alert("Error saving database. Your data might be too large for localStorage.");
            }
        }

        function loadDB() {
            const storedDB = localStorage.getItem('timestampDB');
            if (storedDB) {
                try {
                    db = JSON.parse(storedDB);
                    exportJsonText.value = JSON.stringify(db, null, 2);
                } catch (e)
                {
                    console.error("Failed to parse stored DB:", e);
                    db = {};
                }
            } else {
                db = {};
            }
        }

        function savePlayerState() {
            if (wavesurfer) {
                playerState.currentTime = wavesurfer.getCurrentTime();
            }
            localStorage.setItem('playerState', JSON.stringify(playerState));
        }

        function loadPlayerState() {
            const storedState = localStorage.getItem('playerState');
            if (storedState) {
                try {
                    playerState = JSON.parse(storedState);
                } catch (e) {
                    console.error("Failed to parse player state:", e);
                    playerState = { currentFile: null, currentTime: 0 };
                }
            }
        }

        function populateChapterSelect() {
            for (let i = 1; i <= 114; i++) {
                const chapterNum = i.toString().padStart(3, '0');
                const option = document.createElement('option');
                option.value = chapterNum;
                option.text = `Chapter ${chapterNum}`;
                chapterSelect.appendChild(option);
            }
        }

        function initWaveSurfer() {
            if (wavesurfer) {
                wavesurfer.destroy();
            }
            
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                /* --- Keeping v6 Colors --- */
                waveColor: 'rgb(200, 200, 200)',    // Light grey for unplayed
                progressColor: 'rgb(70, 70, 130)',  // Dark blue for played
                cursorColor: '#d9534f',             // Bright red for the cursor
                /* --- End Colors --- */
                height: 128,
                barWidth: 2,
                barGap: 1,
                cursorWidth: 2
            });

            // --- WaveSurfer Event Listeners ---
            
            wavesurfer.on('ready', () => {
                loadingIndicator.style.display = 'none';
                console.log('Waveform ready.');
                
                wavesurfer.zoom(parseInt(zoomSlider.value));

                wavesurfer.setTime(playerState.currentTime);
                timeDisplay.textContent = formatTime(playerState.currentTime);
            });
            
            wavesurfer.on('loading', (percent) => {
                loadingIndicator.textContent = `Decoding Waveform... ${percent}%`;
                loadingIndicator.style.display = 'inline';
            });

            wavesurfer.on('timeupdate', (currentTime) => {
                timeDisplay.textContent = formatTime(currentTime);
                playerState.currentTime = currentTime;
                savePlayerState();
            });

            wavesurfer.on('error', (err) => {
                console.error('Wavesurfer error:', err);
                loadingIndicator.textContent = `Error loading file. Check console.`;
            });
        }
        
        function loadChapter(chapterNum) {
            const fileName = `coran_${chapterNum}.mp3`;
            const filePath = `https://ia601404.us.archive.org/34/items/elsagrado/${fileName}`;
            
            playerState.currentFile = fileName;
            playerState.currentTime = 0;
            savePlayerState();
            
            currentChapterTitle.textContent = `coran_${chapterNum}`;
            
            wavesurfer.load(filePath + '?t=' + new Date().getTime());

            renderCurrentChapterClips();
            updateTagStatusUI('orange');
        }

        function renderCurrentChapterClips() {
            clipsList.innerHTML = '';
            if (!playerState.currentFile) return;

            const chapterKey = playerState.currentFile.split('.')[0];
            const clips = db[chapterKey] || [];

            if (clips.length === 0) {
                clipsList.innerHTML = '<li>No clips marked for this chapter yet.</li>';
            } else {
                clips.forEach(clip => {
                    const li = document.createElement('li');
                    li.textContent = `Verse ${clip.verse}: ${clip.start}  ‚Üí  ${clip.end}`;
                    
                    const jumpBtn = document.createElement('button');
                    jumpBtn.textContent = 'Jump to Start';
                    jumpBtn.onclick = () => {
                        wavesurfer.setTime(timeStringToSeconds(clip.start));
                        wavesurfer.play();
                    };
                    li.appendChild(jumpBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.style.color = 'red';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete Verse ${clip.verse}?`)) {
                            deleteClip(chapterKey, clip.verse);
                        }
                    };
                    li.appendChild(deleteBtn);

                    clipsList.appendChild(li);
                });
            }
        }

        function deleteClip(chapterKey, verseToDelete) {
            if (!db[chapterKey]) return;
            let chapterClips = db[chapterKey];
            chapterClips = chapterClips.filter(clip => clip.verse !== verseToDelete);
            chapterClips.forEach((clip, index) => {
                clip.verse = index + 1;
            });
            db[chapterKey] = chapterClips;
            saveDB();
            renderCurrentChapterClips();
        }

        function timeStringToSeconds(timeString) {
            const parts = timeString.split(':');
            const secondsAndMs = parseFloat(parts[2]);
            return (parseInt(parts[0]) * 3600) + (parseInt(parts[1]) * 60) + secondsAndMs;
        }

        function updateTagStatusUI(state) {
            taggingState = state;
            if (state === 'orange') {
                tagStatus.style.backgroundColor = 'orange';
                tagStatus.style.color = '#333';
                tagStatus.textContent = 'Waiting for Arabic End (Press 1)';
            } else {
                tagStatus.style.backgroundColor = 'lightgreen';
                tagStatus.style.color = '#333';
                tagStatus.textContent = 'Waiting for Spanish End (Press 2)';
            }
        }

        function handleMarkStart() {
            if (taggingState !== 'orange') return;
            currentStartTime = wavesurfer.getCurrentTime();
            updateTagStatusUI('green');
            console.log(`Marked START at ${formatTime(currentStartTime)}`);
        }

        function handleMarkEnd() {
            if (taggingState !== 'green') return;
            
            const endTime = wavesurfer.getCurrentTime();
            if (endTime <= currentStartTime) {
                alert("End time must be after start time.");
                return;
            }

            const chapterKey = playerState.currentFile.split('.')[0];
            if (!db[chapterKey]) {
                db[chapterKey] = [];
            }
            
            const verseNum = db[chapterKey].length + 1;
            const newClip = {
                verse: verseNum,
                start: formatTime(currentStartTime),
                end: formatTime(endTime)
            };

            db[chapterKey].push(newClip);
            saveDB();
            renderCurrentChapterClips();

            console.log(`Saved CLIP ${verseNum}: ${newClip.start} -> ${newClip.end}`);

            currentStartTime = null;
            updateTagStatusUI('orange');
        }

        function setZoom(newZoom) {
            const min = parseInt(zoomSlider.min);
            const max = parseInt(zoomSlider.max);
            newZoom = Math.max(min, Math.min(max, newZoom));
            
            zoomSlider.value = newZoom;
            if (wavesurfer) {
                wavesurfer.zoom(newZoom);
            }
        }

        function handleGlobalKeydown(e) {
            if (e.target === importJsonText) {
                return;
            }
            if (!wavesurfer) return;

            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    wavesurfer.playPause();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    wavesurfer.skip(-1);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    wavesurfer.skip(1);
                    break;
                case '1':
                    e.preventDefault();
                    handleMarkStart();
                    break;
                case '2':
                    e.preventDefault();
                    handleMarkEnd();
                    break;
                case '+':
                case '=':
                    e.preventDefault();
                    setZoom(parseInt(zoomSlider.value) + 50);
                    break;
                case '-':
                    e.preventDefault();
                    setZoom(parseInt(zoomSlider.value) - 50);
                    break;
            }
        }

        function handleImport() {
            const jsonToImport = importJsonText.value;
            if (!jsonToImport) {
                alert("Import box is empty.");
                return;
            }
            if (!confirm("This will OVERWRITE all locally saved data. Are you sure?")) {
                return;
            }

            try {
                const newData = JSON.parse(jsonToImport);
                db = newData;
                saveDB();
                renderCurrentChapterClips();
                importJsonText.value = "";
                alert("Import successful! All data has been overwritten.");
            } catch (e) {
                console.error("Import failed:", e);
                alert("Import failed. The JSON seems to be invalid. Check console for details.");
            }
        }

        // --- INITIALIZATION ---
        
        window.addEventListener('load', () => {
            populateChapterSelect();
            loadDB();
            loadPlayerState();
            initWaveSurfer();
            
            if (playerState.currentFile) {
                const chapterNum = playerState.currentFile.split('_')[1].split('.')[0];
                chapterSelect.value = chapterNum;
                currentChapterTitle.textContent = `coran_${chapterNum}`;
                
                const fileName = `coran_${chapterNum}.mp3`;
                const filePath = `https://ia601404.us.archive.org/34/items/elsagrado/${fileName}`;
                wavesurfer.load(filePath + '?t=' + new Date().getTime());
            
            } else {
                chapterSelect.value = "001";
                loadChapter("001");

            }
            
            renderCurrentChapterClips();
            updateTagStatusUI('orange');

            document.addEventListener('keydown', handleGlobalKeydown);
            chapterSelect.addEventListener('change', (e) => loadChapter(e.target.value));
            importButton.addEventListener('click', handleImport);

            zoomSlider.addEventListener('input', () => {
                const zoomLevel = parseInt(zoomSlider.value);
                if (wavesurfer) {
                    wavesurfer.zoom(zoomLevel);
                }
            });
        });

    </script>
</body>
</html>
